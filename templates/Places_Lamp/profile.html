
<h1>Your Lamps</h1>

<h2>Unestablished connection</h2>
<table id="unestablished-table">
  {% if unestablished_lamps|length %}
  <thead>
    <tr><th>Name</th><th>Room</th><th>Token</th></tr>
  </thead>
  {% endif %}
  <tbody>
    {% for lamp in unestablished_lamps %}
    
    <tr data-token="{{ lamp.token }}" id="lamp-{{ lamp.id }}">
      <td>{{ lamp.name }}</td>
      <td>{{ lamp.room.name }}</td>
      <td >{{ lamp.token }}</td>
      <td><button class="delete-btn1">üóëÔ∏è Delete</button></td>

    </tr>
    
    {% empty %}
    <tr><td colspan="4">No Unstablished lamps found</td></tr>
    {% endfor %}
  </tbody>
</table>
<h2>Established connection</h2>
<table id="established-table">
  {% if established_lamps|length  %}
  <thead>
    <tr><th>Name</th><th>Room</th><th>Status</th><th>Action</th><th>Token</th></tr>
  </thead>
  {% endif %}
  <tbody>
    {% for lamp in established_lamps %}
    
    <tr data-token="{{ lamp.token }}" id="lamp-{{ lamp.id }}">
      <td>{{ lamp.name }}</td>
      <td>{{ lamp.room.name }}</td>
      <td class="status">{% if lamp.status %} ON {% else %} OFF {% endif %}</td>
            <td>
        <label>
          <input type="checkbox" class="toggle-checkbox" {% if lamp.status %}checked{% endif %} />
        </label>
      </td>
      <td >{{ lamp.token }}</td>
       <td><button class="delete-btn">üóëÔ∏è Delete</button></td>

    </tr>
    
    {% empty %}
    <tr><td colspan="4">No Established lamps found</td></tr>
    {% endfor %}
  </tbody>
</table>

<script>
(function(){
  const protocol = window.location.protocol === "https:" ? "wss" : "ws";
  const wsUrl = `${protocol}://${window.location.host}/ws/light/`;

  // --- UI status indicator ---
  const statusEl = document.createElement("div");
  statusEl.id = "ws-status";
  statusEl.style.cssText = "position:fixed;right:10px;bottom:10px;padding:6px 10px;border-radius:6px;background:#eee;color:#000;z-index:9999;";
  statusEl.textContent = "WS: connecting...";
  document.body.appendChild(statusEl);

  let socket = null;

  function connect() {
    console.log("Connecting to", wsUrl);
    socket = new WebSocket(wsUrl);

    socket.addEventListener("open", () => {
      console.log("WS open ‚úÖ");
      statusEl.textContent = "WS: open";
      statusEl.style.background = "#c8f7c5";
    });

    socket.addEventListener("close", (ev) => {
      console.log("WS closed ‚ùå", ev);
      statusEl.textContent = "WS: closed";
      statusEl.style.background = "#f7c5c5";
      setTimeout(connect, 3000); // auto-reconnect
    });

    socket.addEventListener("error", (e) => {
      console.error("WS error", e);
      statusEl.textContent = "WS: error";
      statusEl.style.background = "#f7c5c5";
    });

    socket.addEventListener("message", (e) => {
      try {
        const data = JSON.parse(e.data);
        console.log("‚¨ÖÔ∏è WS message:", data);

        // Determine establishment flag (prefer top-level field)
        const isEstablish = (data.establish === true) || (data.raw && data.raw.establish);
        const isUnestablish = (data.establish === false) || (data.raw && data.raw.establish === false);

        if (isEstablish) {
  // ...
  const unRow = document.querySelector(`#unestablished-table tr[data-token="${data.token}"]`)
  let row = unRow;
  if (!row) { // If the row isn't unestablished (meaning it's already established)...
    // ... it creates a brand new row! <-- THIS CAUSES DUPLICATION
    const tbl = document.querySelector('#established-table tbody');
    row = document.createElement('tr');
    // ...
    tbl.appendChild(row);
  } else {
            // move row into established table
            const estBody = document.querySelector('#established-table tbody');
            estBody.appendChild(row);
            // add status cell and checkbox if missing
            if (!row.querySelector('.status')) {
              const statusCell = document.createElement('td');
              statusCell.className = 'status';
              statusCell.textContent = data.status ? 'On' : 'Off';
              row.insertBefore(statusCell, row.children[2]);
              const actionCell = document.createElement('td');
              actionCell.innerHTML = `<label><input type="checkbox" class="toggle-checkbox" ${data.status? 'checked':''} /></label>`;
              row.insertBefore(actionCell, row.children[3]);
            }
          }
        }

        if (isUnestablish) {
          // Move row back to unestablished table if present
          const estRow = document.querySelector(`#established-table tr[data-token="${data.token}"]`)
          if (estRow) {
            // remove status and action cells if present
            const statusCell = estRow.querySelector('.status');
            if (statusCell) statusCell.remove();
            const actionCell = estRow.querySelector('.toggle-checkbox');
            if (actionCell) actionCell.closest('td').remove();
            // move to unestablished table body
            const unBody = document.querySelector('#unestablished-table tbody');
            // ensure row has Name / Room / Token cells
            // if not, recreate a simple row
            if (estRow.children.length < 3) {
              const newRow = document.createElement('tr');
              newRow.setAttribute('data-token', data.token);
              newRow.innerHTML = `\n                <td>${data.lamp||''}</td>\n                <td>${data.room||''}</td>\n                <td>${data.token}</td>\n              `;
              unBody.appendChild(newRow);
              estRow.remove();
            } else {
              unBody.appendChild(estRow);
            }
          }
        }

        // update status for any matching row in established table
        const rows = document.querySelectorAll(`#established-table tr[data-token="${data.token}"]`);
        rows.forEach(r => {
          const statusCell = r.querySelector(".status");
          if (statusCell) statusCell.textContent = data.status ? "On" : "Off";
          const cb = r.querySelector(".toggle-checkbox");
          if (cb) cb.checked = !!data.status;
        });
      } catch(err) {
        console.error("Invalid WS data", err);
      }
    });
  }

  connect();

  // --- Event delegation for checkboxes ---
  document.addEventListener("change", (ev) => {
    if (!ev.target.matches(".toggle-checkbox")) return;
    const row = ev.target.closest("tr");
    if (!row) return;

    const token = row.getAttribute("data-token");
    const payload = ev.target.checked ? "ON" : "OFF";

    console.log("‚û°Ô∏è Sending via WS:", { token, payload });

    if (!socket || socket.readyState !== WebSocket.OPEN) {
      console.warn("WS not open - cannot send message");
      return;
    }

    socket.send(JSON.stringify({ token, payload }));

    // Optimistic UI update
    const statusCell = row.querySelector(".status");
    if (statusCell) statusCell.textContent = ev.target.checked ? "On" : "Off";
  });

  // Delete button handler: send DEL over websocket and remove row optimistically
  document.addEventListener("click", (ev) => {
    if (!ev.target.matches('.delete-btn')) return;
    const row = ev.target.closest('tr');
    if (!row) return;
    const token = row.getAttribute('data-token');

    const msg = { token, payload: 'DEL' };
    console.log('‚û°Ô∏è Sending DEL via WS:', msg);
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify(msg));
      // optimistic removal
      row.remove();
    } else {
      console.warn('WS not open - cannot send DEL');
    }
  });

})();


</script>
